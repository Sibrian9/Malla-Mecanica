<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Malla Curricular Ingeniería Mecánica</title>
  <style>
    /* (El estilo permanece igual que antes para mantener apariencia limpia) */
  </style>
</head>
<body>
  <h1>Malla Curricular Ingeniería Mecánica</h1>
  <div style="text-align:center; margin-bottom: 10px;">
    <label><input type="checkbox" id="modoCiclo"> Activar lógica de ciclos pares/impares</label>
  </div>
  <div id="resumen">0 materias aprobadas</div>
  <div class="grid" id="malla"></div>
  <script>
    const data = {
      "Ciclo 1": [["CGR115", "Comunicación espacial gráfica", []], ["MAT115", "Matemática I", []], ["MTE115", "Métodos experimentales", []], ["PSI115", "Psicología Social", []]],
      "Ciclo 2": [["DIT115", "Dibujo Técnico", ["CGR115"]], ["FIR115", "Física I", ["MAT115", "MTE115"]], ["MAT215", "Matemática II", ["MAT115"]], ["HSE115", "Historia social y económica", ["PSI115"]], ["QTR115", "Química Técnica", ["MTE115"]]],
      "Ciclo 3": [["FIR215", "Física II", ["FIR115", "MAT215"]], ["IAI115", "Intro a la informática", []], ["MAT315", "Matemática III", ["MAT215"]], ["MSO115", "Mecánica sólidos I", ["FIR115", "MAT215"]], ["PYE115", "Probabilidad", ["MAT215"]]],
      "Ciclo 4": [["CMI115", "Ciencia Materiales I", ["FIR115", "QTR115"]], ["FIR315", "Física III", ["FIR215", "MAT315"]], ["MAT415", "Matemática IV", ["MAT315"]], ["MSO215", "Mecánica sólidos II", ["MAT315", "MSO115"]], ["PRN115", "Programación I", ["IAI115"]]],
      "Ciclo 5": [["ACE115", "Análisis Circuitos", ["FIR315", "MAT415"]], ["CMI215", "Ciencia Materiales II", ["CMI115"]], ["MSO315", "Mecánica sólidos III", ["MAT415", "MSO215"]], ["PRN215", "Programación II", ["PRN115"]], ["TER115", "Termodinámica I", ["FIR215", "MAT415"]], ["MFS115", "Metalurgia Soldadura", ["PDF215"], true]],
      "Ciclo 6": [["DEM115", "Diseño Máquinas I", ["CMI215", "DIT115", "MSO315"]], ["MEL115", "Máquinas Eléctricas", ["ACE115"]], ["MEF115", "Mecánica de Fluidos", ["FIR215", "MAT415", "MSO215"]], ["PDF115", "Proc. Fabricación I", ["CMI215", "MSO315"]], ["TER215", "Termodinámica II", ["TER115"]], ["SDR115", "Sist. Refrigeración", ["TFC115"], true]],
      "Ciclo 7": [["DEM215", "Diseño Máquinas II", ["DEM115"]], ["SEE115", "Eficiencia Energética y Sostenibilidad", ["TER215"], true], ["FEL115", "Electrónica", ["ACE115"]], ["MID115", "Máquinas Hidráulicas", ["MEF115", "MEL115"]], ["PDF215", "Proc. Fabricación II", ["PDF115"]], ["TFC115", "Transferencia Calor", ["TER215"]]],
      "Ciclo 8": [["DEM315", "Diseño Máquinas III", ["DEM215"]], ["IEC115", "Ing. Económica", ["PYE115"]], ["ISM115", "Inst. Eléctricas", ["MEL115"]], ["MCI115", "Motores CI", ["TER215"]], ["SHN115", "Sistemas Hidráulicos", ["MID115"]], ["EFE115", "Eficiencia Energética", ["TER215"], true]]
    };

    const estado = JSON.parse(localStorage.getItem("malla_aprobadas") || "{}");
    let modoCiclo = localStorage.getItem("modo_ciclo") === "true";
    const actualizadores = [], materiasTotal = [], materiasElectivas = [];

    document.getElementById("modoCiclo").checked = modoCiclo;
    document.getElementById("modoCiclo").addEventListener("change", e => {
      modoCiclo = e.target.checked;
      localStorage.setItem("modo_ciclo", modoCiclo);
      actualizarTodo();
    });

    function guardarEstado() {
      localStorage.setItem("malla_aprobadas", JSON.stringify(estado));
    }

    function crearMateria(id, nombre, requisitos = [], electiva = false, cicloNumero = 0) {
      requisitos = requisitos || [];
      const div = document.createElement("div");
      div.className = "materia";
      if (electiva) {
        div.classList.add("electiva");
        materiasElectivas.push(id);
      }
      div.textContent = `${nombre} (${id})`;
      materiasTotal.push(id);

      function actualizarEstado() {
        let bloqueada = requisitos.length && !requisitos.every(r => estado[r]);

        // Restricción por ciclo par/impar (excepto MEF115)
        if (modoCiclo && id !== "MEF115") {
          const cicloImpar = cicloNumero % 2 === 1;
          const ciclosActivos = materiasTotal.filter(cid => estado[cid])
            .map(cid => cicloMap[cid])
            .filter(n => n % 2 === (cicloImpar ? 1 : 0));
          if (ciclosActivos.length && ciclosActivos.some(n => n % 2 !== cicloNumero % 2)) {
            bloqueada = true;
          }
        }

        div.classList.remove("bloqueada", "aprobada", "pendiente");
        if (estado[id]) {
          div.classList.add("aprobada");
        } else if (bloqueada) {
          div.classList.add("bloqueada");
        } else {
          div.classList.add("pendiente");
        }
      }

      div.addEventListener("click", () => {
        if (div.classList.contains("bloqueada")) return;
        estado[id] = !estado[id];
        guardarEstado();
        actualizarTodo();
      });

      return { div, actualizarEstado };
    }

    const cicloMap = {}; // Mapea materia a número de ciclo
    const malla = document.getElementById("malla");
    let cicloNum = 1;
    for (const ciclo in data) {
      const col = document.createElement("div");
      col.className = "ciclo";
      const title = document.createElement("h2");
      title.textContent = ciclo;
      col.appendChild(title);

      data[ciclo].forEach(([id, nombre, requisitos, electiva]) => {
        cicloMap[id] = cicloNum;
        const { div, actualizarEstado } = crearMateria(id, nombre, requisitos, electiva, cicloNum);
        col.appendChild(div);
        actualizadores.push(actualizarEstado);
      });

      malla.appendChild(col);
      cicloNum++;
    }

    function actualizarResumen() {
      const aprobadas = materiasTotal.filter(id => estado[id]);
      const noElectivaAprob = aprobadas.filter(id => !materiasElectivas.includes(id)).length;
      const electivaAprob = aprobadas.filter(id => materiasElectivas.includes(id)).length;
      const totalReales = materiasTotal.filter(id => !materiasElectivas.includes(id)).length + 5;
      const progreso = Math.min(noElectivaAprob + Math.min(5, electivaAprob), totalReales);
      const percent = ((progreso / totalReales) * 100).toFixed(1);
      document.getElementById("resumen").textContent =
        `${progreso} materias aprobadas de ${totalReales} (${percent}%)`;
    }

    function actualizarTodo() {
      actualizadores.forEach(fn => fn());
      actualizarResumen();
    }

    actualizarTodo();
  </script>
</body>
</html>
